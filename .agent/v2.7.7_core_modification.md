# v2.7.7 核心修改 - \_json_to_text 函數重構

## 📍 檔案位置

`text_script_editor.py` 第 3614-4100 行

## 🎯 核心變更邏輯

### 原理說明

舊格式使用「絕對時間」：

- 每個動作都記錄從開始的絕對時間 `T=0s000`
- 延遲時間是動作本身的持續時間

新格式使用「間隔模式」：

- 移除所有 `T=` 時間戳
- 在動作之間插入 `>間隔XXms` 表示等待時間
- 動作的延遲時間直接寫在後面

### 關鍵修改點

#### 1. 添加間隔時間追蹤

```python
def _json_to_text(self, data: Dict) -> str:
    events = data.get("events", [])
    lines = []

    # 新增：追蹤上一個動作的結束時間
    last_action_end_time = 0.0

    pressed_keys = {}
    start_time = events[0]["time"] if events else 0
```

#### 2. 修改所有 lines.append 語句

**按鍵指令 (行 3666, 3677, 3683, 3690)**

```python
# 舊: lines.append(f">按下{key_name}, 延遲{press_delay}ms, T={time_str}\n")
# 新:
# 1. 計算間隔
interval_ms = int((time_offset - last_action_end_time) * 1000)
if interval_ms > 0:
    lines.append(f">間隔{interval_ms}ms\n")

# 2. 添加動作（不含 T=）
lines.append(f">按下{key_name}, {press_delay}ms\n")

# 3. 更新結束時間
last_action_end_time = time_offset + press_delay / 1000.0
```

**滑鼠點擊 (行 3714)**

```python
# 舊: lines.append(f">{button_name}點擊({x},{y}), 延遲{duration_ms}ms, T={time_str}\n")
# 新:
interval_ms = int((time_offset - last_action_end_time) * 1000)
if interval_ms > 0:
    lines.append(f">間隔{interval_ms}ms\n")
lines.append(f">{button_name}點擊({x},{y}), {duration_ms}ms\n")
last_action_end_time = time_offset + duration_ms / 1000.0
```

**滑鼠移動 (行 3698)**

```python
# 舊: lines.append(f">移動至({x},{y}), 延遲0ms, T={time_str}\n")
# 新:
interval_ms = int((time_offset - last_action_end_time) * 1000)
if interval_ms > 0:
    lines.append(f">間隔{interval_ms}ms\n")
lines.append(f">移動至({x},{y}), 0ms\n")
last_action_end_time = time_offset
```

**延遲指令 (行 3900)**

```python
# 舊: lines.append(f">延遲{duration_ms}ms, T={time_str}\n")
# 新: 延遲指令改為間隔指令
interval_ms = int((time_offset - last_action_end_time) * 1000)
if interval_ms > 0:
    lines.append(f">間隔{interval_ms}ms\n")
lines.append(f">間隔{duration_ms}ms\n")
last_action_end_time = time_offset + duration_ms / 1000.0
```

## 📝 完整修改清單

需要修改的所有 lines.append 位置：

- [ ] 3666: 按下按鍵
- [ ] 3677: 放開按鍵
- [ ] 3683: 按鍵（自動配對）
- [ ] 3690: 按鍵（普通配對）
- [ ] 3698: 滑鼠移動
- [ ] 3714: 滑鼠點擊
- [ ] 3719: 按下滑鼠鍵
- [ ] 3730: 放開滑鼠鍵
- [ ] 3735: 滾輪
- [ ] 3739: 範圍結束
- [ ] 3895: 辨識任一
- [ ] 3900: 延遲
- [ ] 3906: 戰鬥指令
- [ ] 3914: 設定變數
- [ ] 3922: 變數加1
- [ ] 3930: 變數減1
- [ ] 4003: 隨機延遲
- [ ] 以及其他所有包含 `T={time_str}` 的行

## ⚠️ 注意事項

1. **間隔計算**：間隔 = 當前動作時間 - 上一個動作結束時間
2. **結束時間更新**：動作結束時間 = 動作開始時間 + 動作持續時間
3. **0ms 處理**：即使是 0ms 也要寫出來（按您的要求）
4. **標籤和註解**：不影響時間計算，不需要添加間隔

## 🚀 建議實施方式

由於修改點太多（50+ 處），建議：

1. 先備份原始檔案
2. 使用查找替換功能批次處理
3. 手動調整特殊情況
4. 逐步測試每個功能

## 💡 替代方案

如果手動修改太複雜，可以考慮：

1. 使用 Python 腳本自動修改原始碼
2. 或者先實現「舊格式載入時自動轉換」功能
3. 新錄製的使用新格式，舊腳本自動轉換
