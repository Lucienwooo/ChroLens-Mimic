# 腳本合併功能升級說明

# 更新時間：2026-01-21

## 功能升級

### 新增功能：支援重複添加同一腳本

現在您可以在合併腳本時，重複添加同一個腳本到合併序列中。

### 使用範例

假設您有腳本 A、B、C、D，現在可以創建如下的合併序列：

```
A → B → A → C → A → D
```

這意味著：

1. 執行腳本 A
2. 執行腳本 B
3. 再次執行腳本 A
4. 執行腳本 C
5. 再次執行腳本 A
6. 執行腳本 D

### 操作步驟

1. **打開合併對話框**
   - 在腳本設定頁面，點擊「合併腳本」按鈕

2. **添加腳本到合併序列**
   - 左側：顯示所有可用的腳本
   - 選擇一個腳本，點擊「添加 →」按鈕
   - 可以重複選擇同一個腳本並添加多次

3. **調整順序**
   - 在右側合併列表中選擇項目
   - 使用「↑ 上移」和「↓ 下移」按鈕調整順序

4. **設定延遲**
   - 雙擊合併列表中的任一項目
   - 設定該腳本執行後的延遲時間（秒）
   - 每個位置的腳本可以有不同的延遲時間

5. **執行合併**
   - 輸入新腳本的名稱
   - 點擊「合併」按鈕

### 技術細節

#### 數據結構變更

**之前：**

```python
script_delays = {
    "script_A": 5,
    "script_B": 3
}
```

問題：無法區分同一腳本的不同出現位置

**現在：**

```python
merge_data_list = [
    {"name": "script_A", "delay": 5},
    {"name": "script_B", "delay": 3},
    {"name": "script_A", "delay": 2},  # 同一腳本可以再次出現
]
```

優點：每個位置都有獨立的延遲設定

#### 修改的函數

1. **add_to_merge()**
   - 移除了重複檢查
   - 允許同一腳本多次添加

2. **remove_from_merge()**
   - 使用索引刪除，支援刪除重複項

3. **move_up() / move_down()**
   - 同步移動 UI 和數據結構

4. **on_double_click()**
   - 使用索引訪問 merge_data_list
   - 顯示腳本編號（#1, #2, ...）

5. **do_merge()**
   - 直接遍歷 merge_data_list
   - 從數據結構中獲取延遲時間

### 顯示改進

- 延遲設定對話框現在會顯示腳本編號，例如：「腳本：script_A (#3)」
- 日誌輸出也會顯示編號，例如：「✓ 腳本 script_A (#3) 設定延遲 5 秒」

### 兼容性

- 完全向後兼容
- 舊的合併方式仍然可以正常使用
- 只是新增了重複添加的能力

## 測試建議

1. 創建簡單的測試腳本 A、B、C
2. 嘗試合併序列：A → B → A → C
3. 為每個位置設定不同的延遲
4. 執行合併並測試結果

## 已知限制

無

## 未來改進建議

1. 可視化顯示合併序列（流程圖）
2. 支援拖放排序
3. 批量設定延遲
4. 預覽合併後的總執行時間
