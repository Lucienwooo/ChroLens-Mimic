# 🧪 測試 2.7.2 → 2.7.3 自動更新功能

## 📦 測試版本已創建

**檔案：** `ChroLens_Mimic_v2.7.3_TEST.zip`  
**大小：** 67.86 MB  
**用途：** 測試從 2.7.2 自動升級到 2.7.3 的完整流程

---

## ✅ 已包含的測試標記

更新完成後，您應該在程式目錄看到：
- `TEST_v2.7.3.txt` - 測試版本標記檔案

---

## 🧪 測試方法

### 方法 1：手動模擬完整更新流程（推薦）

#### 步驟 1：準備測試環境
```powershell
# 1. 備份當前 2.7.2 版本（重要！）
Copy-Item "dist\ChroLens_Mimic" -Destination "dist\ChroLens_Mimic_BACKUP_2.7.2" -Recurse

# 2. 將測試 ZIP 放到容易存取的位置
Move-Item "ChroLens_Mimic_v2.7.3_TEST.zip" -Destination "C:\Temp\" -Force
```

#### 步驟 2：修改 version_manager.py 進行測試
由於沒有真實的 GitHub Release，您需要暫時修改程式碼：

在 `version_manager.py` 的 `download_update` 方法中，暫時跳過下載，直接使用本地 ZIP：

```python
def download_update(self, download_url: str, progress_callback: Optional[Callable] = None) -> Optional[str]:
    # 測試用：直接使用本地 ZIP
    local_test_zip = r"C:\Temp\ChroLens_Mimic_v2.7.3_TEST.zip"
    
    if os.path.exists(local_test_zip):
        self.log(f"測試模式：使用本地 ZIP: {local_test_zip}")
        
        # 複製到臨時目錄
        temp_dir = tempfile.mkdtemp(prefix='chrolens_update_')
        zip_path = os.path.join(temp_dir, 'update.zip')
        shutil.copy2(local_test_zip, zip_path)
        
        self.log(f"已複製到: {zip_path}")
        return zip_path
    
    # 原始下載邏輯...
```

#### 步驟 3：觸發更新測試
```
1. 執行 2.7.2 版本的 ChroLens_Mimic.exe
2. 點擊「整體設定」→「版本資訊」
3. 點擊「立即更新」（會使用本地 ZIP）
4. 觀察更新流程：
   - 下載（從本地複製）
   - 解壓縮
   - 創建批次腳本
   - 程式關閉
   - 批次腳本執行
   - 備份舊版本
   - 複製新檔案
   - 自動重啟
```

#### 步驟 4：驗證結果
```
✓ 程式目錄出現 TEST_v2.7.3.txt
✓ backup\ 目錄包含 2.7.2 版本備份
✓ 程式自動重啟
✓ 所有功能正常運作
```

---

### 方法 2：直接測試批次更新腳本

這個方法不測試「版本資訊」UI，直接測試核心更新邏輯。

#### 步驟 1：解壓測試版本
```powershell
Expand-Archive -Path "ChroLens_Mimic_v2.7.3_TEST.zip" -DestinationPath "C:\Temp\test_update" -Force
```

#### 步驟 2：手動觸發更新
```python
# 在 Python REPL 中測試
from version_manager import VersionManager
import tempfile
import shutil

# 初始化
vm = VersionManager("2.7.2")

# 模擬解壓縮路徑
extract_dir = r"C:\Temp\test_update"

# 執行更新（會創建批次腳本並關閉程式）
vm.apply_update(extract_dir, restart_after=True)
```

#### 步驟 3：關閉程式並觀察
```
1. 批次腳本視窗會出現
2. 等待 3 秒
3. 備份舊檔案
4. 複製新檔案
5. 自動重啟程式
```

---

### 方法 3：使用 manual_update.bat 測試

這是最簡單的測試方法。

#### 步驟 1：解壓測試版本
```powershell
Expand-Archive -Path "ChroLens_Mimic_v2.7.3_TEST.zip" -DestinationPath "C:\Temp\ChroLens_Mimic_2.7.3_TEST" -Force
```

#### 步驟 2：執行更新工具
```
1. 進入測試版本目錄
2. 雙擊執行 manual_update.bat
3. 輸入現有 2.7.2 版本的路徑
4. 確認更新
5. 等待完成
```

#### 步驟 3：驗證
```
進入原 2.7.2 目錄，應該看到：
✓ TEST_v2.7.3.txt
✓ backup\ 目錄（含時間戳）
✓ 所有新檔案
```

---

## 📋 驗證清單

### 更新前檢查
- [ ] 備份當前 2.7.2 版本
- [ ] 確認 ChroLens_Mimic_v2.7.3_TEST.zip 存在
- [ ] 準備好觀察更新流程

### 更新中觀察
- [ ] 程式顯示更新提示
- [ ] 程式自動關閉
- [ ] 批次腳本視窗出現
- [ ] 顯示備份、更新、重啟訊息

### 更新後驗證
- [ ] 程式自動重新啟動
- [ ] 在程式目錄看到 `TEST_v2.7.3.txt`
- [ ] backup\ 目錄包含舊版本備份
- [ ] 程式所有功能正常
- [ ] 無錯誤訊息

### 檔案結構檢查
```
ChroLens_Mimic/
├── ChroLens_Mimic.exe
├── TEST_v2.7.3.txt           ← 🆕 應該出現
├── manual_update.bat
├── 更新說明.txt
├── backup/
│   └── ChroLens_Mimic_backup_2.7.2/  ← 🆕 備份目錄
└── ...
```

---

## 🐛 可能遇到的問題

### 問題 1：批次腳本沒有執行

**原因：** 程式未完全關閉

**解決：**
```
1. 檢查工作管理員，確認沒有 ChroLens_Mimic.exe 進程
2. 手動執行批次腳本（在 Temp 目錄中找）
```

### 問題 2：檔案複製失敗

**原因：** 權限不足或檔案被鎖定

**解決：**
```
1. 以管理員身份執行程式
2. 確認防毒軟體沒有攔截
3. 手動執行更新腳本
```

### 問題 3：程式沒有自動重啟

**原因：** 批次腳本找不到 exe

**解決：**
```
1. 檢查批次腳本內容
2. 確認 exe 路徑正確
3. 手動啟動程式
```

### 問題 4：TEST_v2.7.3.txt 沒有出現

**原因：** ZIP 結構不對或解壓縮失敗

**解決：**
```
1. 手動解壓 ChroLens_Mimic_v2.7.3_TEST.zip
2. 檢查是否有 TEST_v2.7.3.txt
3. 確認 ZIP 內的目錄結構
```

---

## 🔧 除錯技巧

### 1. 啟用詳細日誌

在測試時，可以在批次腳本中加入更多 echo 語句：

```batch
echo [DEBUG] 當前目錄: %CD%
echo [DEBUG] 目標目錄: %APP_DIR%
echo [DEBUG] 來源目錄: %EXTRACT_DIR%
dir "%EXTRACT_DIR%" /b
```

### 2. 檢查批次腳本

批次腳本位置：
```
C:\Users\<使用者>\AppData\Local\Temp\chrolens_update.bat
```

可以在程式關閉前複製這個檔案，檢查內容是否正確。

### 3. 模擬批次腳本執行

手動創建測試批次腳本：

```batch
@echo off
chcp 65001 >nul

set "OLD_DIR=C:\Path\To\2.7.2"
set "NEW_DIR=C:\Temp\test_update"

echo 測試：備份
xcopy /E /I /Y "%OLD_DIR%\*" "%OLD_DIR%\backup\test\" >nul

echo 測試：複製
xcopy /E /I /Y "%NEW_DIR%\*" "%OLD_DIR%\" >nul

echo 測試：啟動
start "" "%OLD_DIR%\ChroLens_Mimic.exe"

pause
```

---

## 📊 預期測試結果

### 成功標準
✅ 整個更新流程無需手動介入  
✅ 程式自動關閉並重啟  
✅ 舊版本被正確備份  
✅ 新檔案被正確複製  
✅ TEST_v2.7.3.txt 出現在程式目錄  
✅ 程式功能正常運作  

### 時間估計
- 準備：2 分鐘
- 更新執行：30 秒
- 驗證：2 分鐘
- **總計：約 5 分鐘**

---

## 🎯 測試完成後

### 1. 還原到 2.7.2（如需要）
```powershell
# 從備份還原
Remove-Item "dist\ChroLens_Mimic" -Recurse -Force
Copy-Item "dist\ChroLens_Mimic_BACKUP_2.7.2" -Destination "dist\ChroLens_Mimic" -Recurse
```

### 2. 清理測試檔案
```powershell
Remove-Item "ChroLens_Mimic_v2.7.3_TEST.zip" -Force
Remove-Item "test_v2.7.3" -Recurse -Force
Remove-Item "C:\Temp\test_update" -Recurse -Force -ErrorAction SilentlyContinue
```

### 3. 記錄測試結果
請記錄：
- 更新流程是否順利？
- 遇到哪些問題？
- 批次腳本執行是否正常？
- 檔案備份是否完整？
- 程式是否自動重啟？

---

## 📝 測試報告範本

```
【測試日期】2025-12-08
【測試方法】方法 1 / 方法 2 / 方法 3
【測試環境】Windows 版本，Python 版本

【測試結果】
✓ / ✗ 程式關閉
✓ / ✗ 批次腳本執行
✓ / ✗ 檔案備份
✓ / ✗ 檔案複製
✓ / ✗ 程式重啟
✓ / ✗ TEST_v2.7.3.txt 出現
✓ / ✗ 功能正常

【遇到的問題】
<描述問題>

【建議改進】
<建議>
```

---

**測試版本創建時間：** 2025年12月8日  
**測試用途：** 驗證 2.7.2 → 2.7.3 自動更新功能  
**重要提醒：** 這不是真正的 2.7.3 版本，僅用於測試更新機制！
