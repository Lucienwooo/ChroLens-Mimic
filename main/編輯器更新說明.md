# ChroLens-Mimic 編輯器更新說明

## 📋 更新摘要 (2024-12-14)

本次更新優化了文字指令編輯器的使用體驗，並新增了 Workflow 流程圖視覺化功能。

---

## ✅ 已完成的更新

### 1. 分類按鈕初始化顏色修復
**問題**: 首次開啟編輯器時，所有分類按鈕都顯示為藍色
**解決**: 修正初始化邏輯，確保只有選中的分類顯示藍色 (#4A90E2)，其他顯示深灰色 (#3a3a3a)
**測試**: ✅ 通過

### 2. 統一指令按鈕高度
**問題**: 不同分類的指令按鈕高度不一致
**解決**: 
- 為所有按鈕添加固定 `height=2` 參數
- 調整 `pady` 從 8 改為 6
- 修改 `sticky` 從 "nsew" 改為 "ew"
**測試**: ✅ 通過

### 3. 語法高亮範圍擴展
**問題**: 文字指令超過一定數量後，配色消失變成白色
**原因**: 語法高亮只處理可見區域±50行
**解決**: 
- 擴展處理範圍從±50行增加到±100行
- 補充缺少的標籤類型 (comment, module_ref, label_foldable, label_end)
**測試**: ✅ 通過

### 4. ⭐ 新增 Workflow 流程圖模式
**功能**: 將文字指令轉換為視覺化流程圖
**特點**:
- 自動解析標籤 (#xxx) 生成節點
- 識別跳轉邏輯 (>>#成功, >>>#失敗)
- 使用顏色區分路徑：
  - 🟢 青綠色實線：成功路徑
  - 🔴 紅色虛線：失敗路徑
- 點擊節點可跳轉回對應的文字行
- 支援滾輪縮放
- 右鍵選單：自動排列、切換回文字模式
**測試**: ✅ 通過 (5 個節點, 10 個連接)

---

## 🎯 使用方式

### Workflow 流程圖模式

1. **切換到圖形模式**
   - 在編輯器頂部勾選「圖形模式」核取框
   - 系統自動解析文字指令並生成流程圖

2. **查看流程圖**
   - 每個節點顯示標籤名稱和指令數量
   - 箭頭連接表示執行流程
   - 使用滑鼠滾輪可縮放畫布

3. **互動功能**
   - 左鍵點擊節點：跳轉到對應的文字行
   - 右鍵點擊畫布：顯示選單
     - 🔄 自動排列：重新排列節點
     - 📝 切換回文字模式：返回文字編輯

4. **切換回文字模式**
   - 取消勾選「圖形模式」
   - 或使用右鍵選單切換

### 語法高亮顏色說明

- **#4ec9b0 (青綠色)**: 標籤、圖片辨識、OCR 文字
- **#9cdcfe (淺藍色)**: 鍵盤操作
- **#569cd6 (藍色)**: 滑鼠座標操作
- **#c586c0 (紫色)**: 條件判斷
- **#dcdcaa (淺黃色)**: 延遲控制
- **#ce9178 (橘色)**: 時間參數、圖片名稱
- **#6a9955 (綠色)**: 註解
- **#ffd700 (金色)**: 模組引用

---

## 📊 測試結果

所有功能測試均已通過：
- ✅ 編輯器正常啟動
- ✅ 分類按鈕顏色正確 (1 藍 6 灰)
- ✅ 語法高亮正常
- ✅ Workflow 流程圖可正常切換
- ✅ 節點生成和連接正確
- ✅ 檔案儲存和重載正常

---

## 🔧 技術細節

### Workflow 解析邏輯

```python
# 標籤識別
if line.startswith('#') and not line.startswith('##'):
    current_label = line
    
# 成功跳轉
if cmd.startswith('>>#'):
    success_target = '#' + cmd.split('#')[1]
    
# 失敗跳轉
elif cmd.startswith('>>>#'):
    fail_target = '#' + cmd.split('#')[1]
```

### 節點佈局算法

- 使用層級佈局 (Level-based Layout)
- 從第一個標籤開始遞歸計算層級
- 同層節點水平排列
- 層與層之間垂直間隔 120px
- 節點水平間隔 300px

### 視覺元素

- 節點：200x60px 圓角矩形
- 邊框：2px 藍色 (#569cd6)
- 背景：深色 (#2d2d30)
- 連接線：2px 寬度，箭頭形狀 (10, 12, 5)

---

## 📝 範例腳本

```
#開始偵測
>辨識>怪物圖示, 範圍(100,100,1920,1080), T=0s100
>範圍結束, T=0s000
>>#攻擊怪物
>>>#移動尋找

#攻擊怪物
>左鍵點擊(960,540), 延遲50ms, T=0s000
>按1, 延遲300ms, T=0s000
>按2, 延遲300ms, T=0s000
>>#檢查血量
>>>#檢查血量

#檢查血量
>辨識>血量低, 範圍(10,10,200,100), T=0s050
>範圍結束, T=0s000
>>#補血
>>>#開始偵測

#補血
>按5, 延遲100ms, T=0s000
>等待, 延遲500ms, T=0s000
>>#開始偵測
>>>#開始偵測

#移動尋找
>按W, 延遲100ms, T=0s000
>等待, 延遲2000ms, T=0s000
>>#開始偵測
>>>#開始偵測
```

此範例會生成 5 個節點和 10 個連接的流程圖。

---

## ⚙️ 相關檔案

- **主編輯器**: `text_script_editor.py`
- **主程式**: `ChroLens_Mimic.py`
- **測試腳本範例**: `scripts/自動打怪範例*.txt`

---

## 🙏 注意事項

1. Workflow 模式需要腳本包含至少一個標籤 (#xxx)
2. 長腳本建議先測試語法高亮是否正常
3. 大型流程圖可使用滾輪縮放查看
4. 舊的 canvas 模式程式碼已保留但未使用

---

**版本**: 2.7+
**更新日期**: 2024-12-14
**測試狀態**: ✅ 全部通過
